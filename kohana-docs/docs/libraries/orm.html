<html xmlns="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>
    libraries:orm    [Kohana User Guide]
</title><meta name="generator" content="DokuWiki Release 2008-05-05"><meta name="robots" content="noindex,nofollow"><meta name="date" content="2008-12-15T13:31:26-0600"><meta name="keywords" content="libraries,orm"><link rel="search" type="application/opensearchdescription+xml" href="..\lib\exe\opensearch.html" title="Kohana User Guide"><link rel="start" href="/"><link rel="contents" href="orm-1.html?do=index" title="Index"><link rel="alternate" type="application/rss+xml" title="Recent Changes" href="..\feed.html"><link rel="alternate" type="application/rss+xml" title="Current Namespace" href="..\feed-4.html?mode=list&amp;ns=libraries"><link rel="alternate" type="text/html" title="Plain HTML" href="..\_export\xhtml\libraries\orm.html"><link rel="alternate" type="text/plain" title="Wiki Markup" href="..\_export\raw\libraries\orm.html"><link rel="stylesheet" media="all" type="text/css" href="..\_css\all.css"><link rel="stylesheet" media="screen" type="text/css" href="..\_css\kohana.css"><link rel="stylesheet" media="print" type="text/css" href="..\_css\print.css"><script type="text/javascript" charset="utf-8" src="..\_js\script.js"></script><link rel="shortcut icon" href="..\lib\tpl\kohana\images\favicon.html"><link rel="stylesheet" type="text/css" href="..\_css\my.css"></head><body>
<!-- Start Header -->
<div id="header">

<!-- Start Logo -->
<a id="logo" href="..\contents.html"><img src="..\_img\kohana.png" alt="Kohana"></a>
<!-- End Logo -->

</div>
<!-- End Header -->

<div class="menu clearfix">
<ul><li class="top active"><a href="..\contents.html">Contents</a></li>


<li class="top"><a href="..\contents.html">General<!--[if IE 7]><!--></a><!--<![endif]-->
<!--[if lte IE 6]><table><tr><td><![endif]-->
	<ul><li><a href="..\general\configuration.html" title="Configuration">Configuration</a></li>
				<li><a href="..\general\controllers.html" title="Controllers">Controllers</a></li>
				<li><a href="..\general\errorhandling.html" title="Error Handling">Error Handling</a></li>
				<li><a href="..\general\events.html" title="Events">Events</a></li>
				<li><a href="..\general\filesystem.html" title="Filesystem">Filesystem</a></li>
				<li><a href="..\general\helpers.html" title="Helpers">Helpers</a></li>
				<li><a href="..\general\hooks.html" title="Hooks">Hooks</a></li>
				<li><a href="..\general\i18n.html" title="Internationalization">Internationalization</a></li>
				<li><a href="..\general\libraries.html" title="Libraries">Libraries</a></li>
				<li><a href="..\general\loading.html" title="Loading">Loading</a></li>
				<li><a href="..\general\logging.html" title="Logging">Logging</a></li>
				<li><a href="..\general\models.html" title="Models">Models</a></li>
				<li><a href="..\general\modules.html" title="Modules">Modules</a></li>
				<li><a href="..\general\routing.html" title="Routing">Routing</a></li>
				<li><a href="..\general\urls.html" title="URLs">URLs</a></li>
				<li><a href="..\general\views.html" title="Views">Views</a></li>
			</ul><!--[if lte IE 6]></td></tr></table></a><![endif]--></li>


<li class="top"><a href="..\contents.html">Core<!--[if IE 7]><!--></a><!--<![endif]-->
<!--[if lte IE 6]><table><tr><td><![endif]-->
	<ul><li><a href="..\core\benchmark.html" title="Benchmark">Benchmark</a></li>
				<li><a href="..\core\config.html" title="Config">Config</a></li>
				<li><a href="..\core\event.html" title="Event">Event</a></li>
				<li><a href="..\core\kohana.html" title="Kohana">Kohana</a></li>
				<li><a href="..\core\log.html" title="Log">Log</a></li>
				<li><a href="..\core\utf8.html" title="Unicode">Unicode</a></li>
				<li><a href="..\core\view.html" title="View">View</a></li>
			</ul><!--[if lte IE 6]></td></tr></table></a><![endif]--></li>


<li class="top"><a href="..\contents.html">Libraries<!--[if IE 7]><!--></a><!--<![endif]-->
<!--[if lte IE 6]><table><tr><td><![endif]-->
	<ul><li><a href="cache.html" title="Cache">Cache</a></li>
				<li><a href="calendar.html" title="Calendar">Calendar</a></li>
				<li><a href="captcha.html" title="Captcha">Captcha</a></li>
				<li><a href="database.html" title="Database">Database</a></li>
				<li><a href="encrypt.html" title="Encrypt">Encrypt</a></li>
				<li><a href="image.html" title="Image">Image</a></li>
				<li><a href="input.html" title="Input">Input</a></li>
				<li><a href="orm.html" title="ORM">ORM</a></li>
				<li><a href="pagination.html" title="Pagination">Pagination</a></li>
				<li><a href="profiler.html" title="Profiler">Profiler</a></li>
				<li><a href="session.html" title="Session">Session</a></li>
				<li><a href="uri.html" title="URI">URI</a></li>
				<li><a href="validation.html" title="Validation">Validation</a></li>
			</ul><!--[if lte IE 6]></td></tr></table></a><![endif]--></li>


<li class="top"><a href="..\contents.html">Helpers<!--[if IE 7]><!--></a><!--<![endif]-->
<!--[if lte IE 6]><table><tr><td><![endif]-->
	<ul><li><a href="..\helpers\arr.html" title="Array">Array</a></li>
				<li><a href="..\helpers\cookie.html" title="Cookie">Cookie</a></li>
				<li><a href="..\helpers\date.html" title="Date">Date</a></li>
				<li><a href="..\helpers\download.html" title="Download">Download</a></li>
				<li><a href="..\helpers\email.html" title="Email">Email</a></li>
				<li><a href="..\helpers\expires.html" title="Expires">Expires</a></li>
				<li><a href="..\helpers\feed.html" title="Feed">Feed</a></li>
				<li><a href="..\helpers\file.html" title="File">File</a></li>
				<li><a href="..\helpers\form.html" title="Form">Form</a></li>
				<li><a href="..\helpers\format.html" title="Format">Format</a></li>
				<li><a href="..\helpers\html.html" title="HTML">HTML</a></li>
				<li><a href="..\helpers\inflector.html" title="Inflector">Inflector</a></li>
				<li><a href="..\helpers\num.html" title="Num">Num</a></li>
				<li><a href="..\helpers\remote.html" title="Remote">Remote</a></li>
				<li><a href="..\helpers\request.html" title="Request">Request</a></li>
				<li><a href="..\helpers\security.html" title="Security">Security</a></li>
				<li><a href="..\helpers\text.html" title="Text">Text</a></li>
				<li><a href="..\helpers\upload.html" title="Upload">Upload</a></li>
				<li><a href="..\helpers\url.html" title="URL">URL</a></li>
				<li><a href="..\helpers\valid.html" title="Valid">Valid</a></li>
			</ul><!--[if lte IE 6]></td></tr></table></a><![endif]--></li>


</ul></div>


<!-- Start Body -->
<div id="body" class="dokuwiki clearfix">

<!-- wikipage start -->
<!-- TOC START -->
<!-- TOC END -->
<table class="inline"><tr class="row0"><th class="col0">Status</th><td class="col1">Draft</td>
	</tr><tr class="row1"><th class="col0">Todo</th><td class="col1">Fill in missing stuff, Missing methods, __get properties, through relationships, clearer explanation/example of the difference between the “loaded” and “saved” properties</td>
	</tr></table><h1><a name="object_relational_mapping_orm_library" id="object_relational_mapping_orm_library">Object Relational Mapping (ORM) Library</a></h1>
<div class="level1">

<p>

Object Relational Mapping (ORM) provides a way to create objects that represent rows from a database. It also provides a way to define and retrieve rows that are related by foreign keys. By creating relationships between models that follow <a href="http://en.wikipedia.org/wiki/%20convention%20over%20configuration" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/%20convention%20over%20configuration"> convention over configuration</a>, much of the repetition of writing queries to <a href="http://en.wikipedia.org/wiki/create%2C%20read%2C%20update%20and%20delete" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/create%2C%20read%2C%20update%20and%20delete">create, read, update and delete</a> information from the database can be reduced or entirely removed.  All of the relationships can be handled automatically by the ORM library and you can access related objects just like standard object properties.
</p>


<div class="box round">
  <b class="xtop"><b class="xb1"></b><b class="xb2"></b><b class="xb3"></b><b class="xb4"></b></b>
  <div class="xbox">
<div class="box_content"><p>
It is highly recommended to use a <a href="http://en.wikipedia.org/wiki/Relational%20Database" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Relational%20Database">Relational Database</a> that supports true <a href="http://en.wikipedia.org/wiki/Foreign%20Key" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Foreign%20Key">Foreign Key</a>s. See <a href="#choosing_a_database" title="libraries:orm ↵" class="wikilink1">Choosing A Database</a> for further information on this topic.
</p></div>
  </div>
  <b class="xbottom"><b class="xb4"></b><b class="xb3"></b><b class="xb2"></b><b class="xb1"></b></b>
</div>


</div>

<h2><a name="getting_started" id="getting_started">Getting Started</a></h2>
<div class="level2">

<p>
Before using the ORM library, you need to create your ORM models and define relationships.

</p>

</div>

<h3><a name="orm_conventions" id="orm_conventions">ORM Conventions</a></h3>
<div class="level3">

<p>
To get the most value out of the ORM library, you should adhere to the conventions outlined below. However, it is possible to override most default conventions via ORM object properties.
</p>
<ul><li class="level1"><div class="li"> <strong>Table names are plural</strong>, e.g. <code>users</code> (override by setting <code>$table_names_plural</code> to FALSE)</div>
</li>
<li class="level1"><div class="li"> <strong>Model names are singular</strong> (e.g. <code>user</code>) with _Model appended to the model name, e.g. <code>User_Model</code> (override by setting  <code>$table_name</code> in your model)</div>
</li>
<li class="level1"><div class="li"> <strong>Each table should have an auto_incrementing column named 'id' as its primary key</strong> (override by setting <code>$primary_key</code> in your model)</div>
</li>
<li class="level1"><div class="li"> <strong>Foreign keys should be named using the 'modelname_id'</strong> (e.g. user_id)</div>
</li>
<li class="level1"><div class="li"> <strong>Pivot tables should use the parent table names in alphabetical order</strong> in the form <code>table1_table2</code>.  For example: If you have a many-to-many relationship between <code>users</code> and <code>roles</code> tables, the join table should be named <code>roles_users</code>.</div>
</li>
</ul></div>

<h3><a name="creating_an_orm_model" id="creating_an_orm_model">Creating an ORM Model</a></h3>
<div class="level3">

<p>
To use ORM, you must first create a <a href="..\general\models.html" class="wikilink1" title="general:models">Model</a> that extends the ORM library.  Each model represents the database table and each object created by the model represents <a href="#finding_rows" title="libraries:orm ↵" class="wikilink1">one or more rows</a> from that table.  A model should be created for each table that is part of a relationship (excluding pivot tables).
</p>

<p>
The syntax for creating an ORM model is as follows:
</p>
<pre class="code php"><span class="kw2">class</span> User_Model <span class="kw2">extends</span> ORM <span class="br0">{</span><span class="br0">}</span></pre>
</div>

<h3><a name="loading_orm_models" id="loading_orm_models">Loading ORM Models</a></h3>
<div class="level3">

<p>
Once your ORM models are defined, you can load ORM models through standard object instantiation or via the static <code>factory</code> method.  Both work exactly the same, but the <code>factory</code> method is chainable, so it is preferred.  You can optionally pass a primary key to the constructor or <code>factory</code> to create a ORM object associated with one specific record.  <strong>Note:</strong> In order to access data in related tables, you need to define relationships in your model.
</p>
<pre class="code php"><span class="co1">// create a new ORM object</span>
<span class="re1">$user</span> <span class="sy0">=</span> <span class="kw2">new</span> User_Model<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="co1">// Create a new ORM object for the primary key of 1</span>
<span class="re1">$user</span> <span class="sy0">=</span> <span class="kw2">new</span> User_Model<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="co1">// Using the factory method</span>
<span class="re1">$user</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'user'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="co1">// Using the factory method with optional primary key</span>
<span class="re1">$user</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'user'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span></pre>
<p>

Note: The <code>find</code> method can also be used to select a different row on a loaded object:
</p>
<pre class="code php"><span class="co1">// Load the user with "id = 2"</span>
<span class="re1">$user</span><span class="sy0">-&gt;</span><span class="me1">find</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h2><a name="accessing_data_from_orm_objects" id="accessing_data_from_orm_objects">Accessing Data from ORM Objects</a></h2>
<div class="level2">

<p>
Once your ORM models are loaded, data is accessible using standard object property notation (<code>$object→property</code>).  In a one-to-many relationship, where many rows from the child model are associated with the parent model, data within the child model is accessible via a <code>foreach</code> loop (the child model is actually an <code>ORM_Iterator</code> object, not an array).  See relationships below.
</p>

<p>
Here is an example that shows how to access ORM data from the user model (part of the Kohana Auth module).
</p>
<pre class="code php"><span class="co1">// accessing data for the user with the primary key of 1</span>
<span class="re1">$user</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'user'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
<a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$user</span><span class="sy0">-&gt;</span><span class="me1">name</span><span class="sy0">;</span></pre>
</div>

<h2><a name="using_database_query_builder_methods" id="using_database_query_builder_methods">Using Database Query Builder Methods</a></h2>
<div class="level2">

<p>
Most <a href="database\builder.html" class="wikilink1" title="libraries:database:builder">query builder methods</a> can be used within ORM and are chainable, giving you a great deal of flexibility and control over the data returned by your ORM models.  <strong>Note: </strong> Calls to <code>query</code>, <code>get</code>, <code>insert</code>, <code>update</code> and <code>delete</code> are <strong>not</strong> allowed within ORM since internal methods exist in ORM for these operations.
</p>
<pre class="code php"><span class="co1">// query builder methods with chaining</span>
<span class="re1">$object</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'model'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">where</span><span class="br0">(</span><span class="st0">'field'</span><span class="sy0">,</span> <span class="st0">'some_value'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">orwhere</span><span class="br0">(</span><span class="st0">'field'</span><span class="sy0">,</span> <span class="st0">'another_value'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">find</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="co1">// retrieve a sorted list of books of the first 20 books associated with author (where id = 1)</span>
<span class="re1">$author</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'author'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
<span class="re1">$sorted_books</span> <span class="sy0">=</span> <span class="re1">$author</span><span class="sy0">-&gt;</span><span class="me1">orderby</span><span class="br0">(</span><span class="st0">'date'</span><span class="sy0">,</span><span class="st0">'desc'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">limit</span><span class="br0">(</span><span class="nu0">20</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">books</span><span class="sy0">;</span></pre>
</div>

<h2><a name="defining_relationships_in_orm" id="defining_relationships_in_orm">Defining Relationships in ORM</a></h2>
<div class="level2">
<table class="inline"><tr class="row0"><th class="col0">Status</th><td class="col1">Draft</td>
	</tr><tr class="row1"><th class="col0">ToDo</th><td class="col1">Fix up examples and move aliases into separate section with more detail and examples</td>
	</tr></table><p>

Understanding relationships is essential to effectively using ORM, as properly defining relationships between your models enables the ORM library to perform its magic.  Before defining relationships, it is a good idea to <a href="http://en.wikipedia.org/wiki/Er_diagram" class="urlextern" title="http://en.wikipedia.org/wiki/Er_diagram" rel="nofollow">document your current database model</a> to get a clear understanding of the various relationships between your tables (one-to-one, one-to-many and many-to-many).  If your database is well documented, it is much easier to properly define the relationships between your ORM models.
</p>

<p>
The ORM library supports the following relationships in your model:

</p>
<ul><li class="level1"><div class="li">  <code>$has_one</code> for one-to-one relationships</div>
</li>
<li class="level1"><div class="li">  <code>$has_many</code> for the parent side of a one-to-many relationship</div>
</li>
<li class="level1"><div class="li">  <code>$belongs_to</code> for the child side of a one-to-many relationship</div>
</li>
<li class="level1"><div class="li">  <code>$has_and_belongs_to_many</code> for many-to-many relationships</div>
</li>
</ul><p>

In the examples that follow, we refer to a <code>Blog</code> database – where a <code>post</code> may have an <code>author</code> and an <code>editor</code> (both of which have user accounts in our database). A blog post may be associated with many <code>categories</code> and may have many <code>comments</code>.

</p>

</div>

<h3><a name="has_one" id="has_one">has_one</a></h3>
<div class="level3">

<p>
The <code>has_one</code> relationship allows you to define a one-to-one relationship between two models.  For example, a blog post has one user.  The foreign key <code>user_id</code> should be defined in your <code>blog_posts</code> table.
</p>
<pre class="code php"><span class="kw2">class</span> Blog_Post_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
 
    protected <span class="re1">$has_one</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'user'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="br0">}</span></pre>
<p>
Now we can access the user from the blog post like this:

</p>
<pre class="code php"><span class="re1">$post</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'blog_post'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">user</span><span class="sy0">-&gt;</span><span class="me1">username</span><span class="sy0">;</span></pre>
</div>

<h3><a name="aliasing" id="aliasing">aliasing</a></h3>
<div class="level3">

<p>
The relationship above is simple and effective, but does not accurately communicate the relationship of the user, as the “author”, to the blog post. However, relationships can be aliased to allow multiple users to have relationships to the post.  <code>Aliasing</code> allows multiple objects of the same type to be related to another object. Aliasing can also be used to simply change the name of the related object to communicate the purpose of the relationship more clearly.
</p>
<pre class="code php"><span class="kw2">class</span> Blog_Post_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
 
    protected <span class="re1">$has_one</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'author'</span> <span class="sy0">=&gt;</span> <span class="st0">'user'</span><span class="sy0">,</span> <span class="st0">'editor'</span> <span class="sy0">=&gt;</span> <span class="st0">'user'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="br0">}</span></pre>
<p>
Now we can access both the author and the editor of the blog post like this:

</p>
<pre class="code php"><span class="re1">$post</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'blog_post'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">author</span><span class="sy0">-&gt;</span><span class="me1">username</span><span class="sy0">;</span>
<a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">editor</span><span class="sy0">-&gt;</span><span class="me1">username</span><span class="sy0">;</span></pre>
<p>
The <code>blog_posts</code> database table would have 2 columns now, <code>blog_posts.author_id</code> and <code>blog_posts.editor_id</code>, and both would have values that exist in <code>users.id</code>.
</p>

<p>

<strong>Note</strong> Aliases can also be used in reverse within the <code>belongs_to</code> relationship as well.

</p>

</div>

<h3><a name="has_many_belongs_to" id="has_many_belongs_to">has_many, belongs_to</a></h3>
<div class="level3">

<p>
The <code>has_many</code> relationship is used in conjunction with <code>belongs_to</code> to define a one-to-many relationship between two models.  Define <code>has_many</code> on the parent side (plural) and <code>belongs_to</code> on the child side (singular).  For example, in a Blog database, each post will have many comments and each comment is associated with one blog post.  The foreign key <code>blog_post_id</code> should be defined in your <code>comments</code> table.  
</p>

<p>
<strong>Note:</strong> Defining a <code>belongs_to</code> relationship in the child model is optional and only required if you need to look up information in the parent model that is associated with the current child model.
</p>
<pre class="code php"><span class="kw2">class</span> Blog_Post_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
 
    protected <span class="re1">$has_one</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'author'</span> <span class="sy0">=&gt;</span> <span class="st0">'user'</span><span class="sy0">,</span> <span class="st0">'editor'</span> <span class="sy0">=&gt;</span> <span class="st0">'user'</span><span class="br0">)</span><span class="sy0">;</span>
    protected <span class="re1">$has_many</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'comments'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="br0">}</span></pre><pre class="code php"><span class="kw2">class</span> Comment_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
 
    <span class="co1">// This is only required if need to find the post by a comment</span>
    protected <span class="re1">$belongs_to</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'blog_post'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="br0">}</span></pre>
<p>
This allows us to do the following:

</p>
<pre class="code php"><span class="re1">$post</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'blog_post'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">foreach</span> <span class="br0">(</span><span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">comments</span> <span class="kw1">as</span> <span class="re1">$comment</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$comment</span><span class="sy0">-&gt;</span><span class="me1">name</span><span class="sy0">,</span> <span class="re1">$comment</span><span class="sy0">-&gt;</span><span class="me1">body</span><span class="sy0">;</span>
<span class="br0">}</span>
 
<span class="co1">// We can also load a post via a comment</span>
<span class="re1">$comment</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'comment'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="re1">$post</span> <span class="sy0">=</span> <span class="re1">$comment</span><span class="sy0">-&gt;</span><span class="me1">blog_post</span><span class="sy0">;</span></pre>
</div>

<h3><a name="has_and_belongs_to_many" id="has_and_belongs_to_many">has_and_belongs_to_many</a></h3>
<div class="level3">

<p>
The <code>has_and_belongs_to_many</code> relationship allows you to define a many-to-many relationship between two tables.  It is important to note that many-to-many relationships require a “pivot table” that minimally contains the primary keys of both tables.  The pivot table should be named in alphabetical order, such as <code>roles_users</code>.  Once defined, <code>has_and_belongs_to_many</code> relationships allow multiple objects to be associated with many other objects, such as relating a blog post to many categories.  The <code>has_and_belongs_to_many</code> relationship must be defined in both models.
</p>

<p>
For example, in a Blog database, blog_posts can be associated with many categories and categories can be associated with many different blog posts.  A table called <code>blog_posts_categories</code> with the columns <code>blog_post_id</code> and <code>category_id</code> is required to establish the relationship between blog posts and categories (defining which categories are associated with various blog posts and vice versa).
</p>
<pre class="code php"><span class="kw2">class</span> Blog_Post_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
 
    protected <span class="re1">$has_one</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'author'</span> <span class="sy0">=&gt;</span> <span class="st0">'user'</span><span class="sy0">,</span> <span class="st0">'editor'</span> <span class="sy0">=&gt;</span> <span class="st0">'user'</span><span class="br0">)</span><span class="sy0">;</span>
    protected <span class="re1">$has_many</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'comments'</span><span class="br0">)</span><span class="sy0">;</span>
    protected <span class="re1">$has_and_belongs_to_many</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'categories'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="br0">}</span></pre><pre class="code php"><span class="kw2">class</span> Category_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
 
    protected <span class="re1">$has_and_belongs_to_many</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'blog_posts'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="br0">}</span></pre>
<p>
We access data from this relationship the same as a <code>has_many</code> relationship:
</p>
<pre class="code php"><span class="re1">$post</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'blog_post'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">foreach</span> <span class="br0">(</span><span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">categories</span> <span class="kw1">as</span> <span class="re1">$category</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$category</span><span class="sy0">-&gt;</span><span class="me1">name</span><span class="sy0">;</span>
<span class="br0">}</span></pre>
<p>
A more useful example may be finding all of the posts that belong to a particular category:
</p>
<pre class="code php"><span class="re1">$category</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'category'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">foreach</span> <span class="br0">(</span><span class="re1">$category</span><span class="sy0">-&gt;</span><span class="me1">blog_posts</span> <span class="kw1">as</span> <span class="re1">$post</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">title</span><span class="sy0">,</span> <span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">author</span><span class="sy0">-&gt;</span><span class="me1">username</span><span class="sy0">,</span> <span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">body</span><span class="sy0">;</span>
<span class="br0">}</span></pre>
</div>

<h2><a name="methods" id="methods">Methods</a></h2>
<div class="level2">

<p>

All of the default public and protected methods of ORM are listed here.
</p>

</div>

<h3><a name="factory" id="factory">factory</a></h3>
<div class="level3">

<p>

Static method used to load ORM objects:

</p>
<pre class="code php"><span class="re1">$object</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="re1">$model_name</span><span class="sy0">,</span> <span class="re1">$row_id</span> <span class="sy0">=</span> <span class="kw2">NULL</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h3><a name="find" id="find">find</a></h3>
<div class="level3">

<p>

Find executes the database query, gets one row and sets the current object to the result.

</p>
<pre class="code php"><span class="co1">// find the article with primary key = 1</span>
<span class="re1">$object</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">find</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
<a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$object</span><span class="sy0">-&gt;</span><span class="me1">title</span><span class="sy0">;</span></pre><pre class="code php"><span class="co1">// find an article by title</span>
<span class="re1">$object</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">where</span><span class="br0">(</span><span class="st0">'title'</span><span class="sy0">,</span> <span class="re1">$title</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">find</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h3><a name="find_all" id="find_all">find_all</a></h3>
<div class="level3">

<p>

Find_all executes a database query and returns the multiple records using the ORM_Iterator

</p>
<pre class="code php"><span class="re1">$articles</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">find_all</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
<span class="kw1">foreach</span><span class="br0">(</span><span class="re1">$articles</span> <span class="kw1">as</span> <span class="re1">$article</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">title</span><span class="sy0">;</span>
<span class="br0">}</span></pre>
<p>
Also you can get a range of the multiple records using additional parameters (like in <acronym title="Structured Query Language">SQL</acronym> LIMIT)

</p>
<pre class="code php"><span class="re1">$limit</span> <span class="sy0">=</span> <span class="nu0">10</span><span class="sy0">;</span>
<span class="re1">$offset</span> <span class="sy0">=</span> <span class="nu0">30</span><span class="sy0">;</span>
<span class="co1">//it will return 10 records started from row #30</span>
<span class="re1">$articles</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">find_all</span><span class="br0">(</span><span class="re1">$limit</span><span class="sy0">,</span><span class="re1">$offset</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h3><a name="save" id="save">save</a></h3>
<div class="level3">

<p>

Save the current object into the database. If the object has no 'id' set it will insert a new record, else it will update.
</p>
<pre class="code php"><span class="re1">$article</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">title</span> <span class="sy0">=</span> <span class="st0">'New title'</span><span class="sy0">;</span>
<span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">save</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span></pre>
<p>
<em>Newly created objects will always be reloaded after they are saved, to properly account for default values of columns.</em>
</p>

</div>

<h3><a name="clear" id="clear">clear</a></h3>
<div class="level3">

<p>

Clears the state of an object, making it empty for reuse.
</p>
<pre class="code php"><span class="re1">$article</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="co1">// Article is now empty</span>
<span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">clear</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<a href="http://www.php.net/var_dump"><span class="kw3">var_dump</span></a><span class="br0">(</span><span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">loaded</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">// returns FALSE</span></pre>
</div>

<h3><a name="reload" id="reload">reload</a></h3>
<div class="level3">

<p>

Reloads the ORM object from the database. If <code>$this→reload_on_wakeup</code> is enabled, <a href="http://php.net/unserialize" class="urlextern" title="http://php.net/unserialize" rel="nofollow">unserializing</a> an object will cause it to be reloaded.
</p>
<pre class="code php"><span class="re1">$article</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">title</span> <span class="sy0">=</span> <span class="st0">'A different title'</span><span class="sy0">;</span>
 
<span class="co1">// Article title will be reset to the saved state</span>
<span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">reload</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<a href="http://www.php.net/var_dump"><span class="kw3">var_dump</span></a><span class="br0">(</span><span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">title</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">// returns the original title</span></pre>
</div>

<h3><a name="delete" id="delete">delete</a></h3>
<div class="level3">

<p>

Delete deletes current object or object with the given id.

</p>
<pre class="code php"><span class="re1">$article</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
<span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">delete</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
<span class="co1">// OR</span>
ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">delete</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">// Only uses one query instead of two</span></pre>
</div>

<h3><a name="delete_all" id="delete_all">delete_all</a></h3>
<div class="level3">

<p>

Delete deletes multiple objects. Will delete all objects of this type with no arguments, or an array can be used to specify the IDs to delete.
</p>
<pre class="code php"><span class="co1">// Deletes all records</span>
ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">delete_all</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="co1">// Deletes records with ID 1, 2, 4, and 5</span>
ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">delete_all</span><span class="br0">(</span><a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="nu0">1</span><span class="sy0">,</span><span class="nu0">2</span><span class="sy0">,</span><span class="nu0">4</span><span class="sy0">,</span><span class="nu0">5</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h3><a name="as_array" id="as_array">as_array</a></h3>
<div class="level3">

<p>

Returns the current object in array format.
</p>
<pre class="code php"><span class="re1">$article</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">as_array</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$article</span><span class="br0">[</span><span class="st0">'title'</span><span class="br0">]</span><span class="sy0">;</span></pre>
</div>

<h3><a name="select_list" id="select_list">select_list</a></h3>
<div class="level3">

<p>

Generates a key/value pair array of all the objects.  The function accepts two column names as parameters: the first column is the value and the second column is the name or description.  This is especially useful when used in conjunction with the form helper to automatically build and populate selection menus.
</p>

<p>
The following example generates links to all articles followed by an <acronym title="HyperText Markup Language">HTML</acronym> select form element pre-populated with all articles.
</p>
<pre class="code php"><span class="re1">$articles</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">select_list</span><span class="br0">(</span><span class="st0">'id'</span><span class="sy0">,</span> <span class="st0">'title'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">foreach</span> <span class="br0">(</span><span class="re1">$articles</span> <span class="kw1">as</span> <span class="re1">$id</span> <span class="sy0">=&gt;</span> <span class="re1">$title</span><span class="br0">)</span>
<span class="br0">{</span>
    <span class="co1">// Display a list of links</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> html<span class="sy0">::</span><span class="me2">anchor</span><span class="br0">(</span><span class="st0">'articles/'</span><span class="sy0">.</span><span class="re1">$id</span><span class="sy0">,</span> <span class="re1">$title</span><span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span>
 
<span class="co1">// Display a dropdown list</span>
<a href="http://www.php.net/echo"><span class="kw3">echo</span></a> form<span class="sy0">::</span><span class="me2">dropdown</span><span class="br0">(</span><span class="st0">'articles'</span><span class="sy0">,</span> <span class="re1">$articles</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h3><a name="has" id="has">has</a></h3>
<div class="level3">

<p>

Tests if an object has a many-to-many relationship with another object. The following code will test if the user has the <code>login</code> role. This method always returns a boolean. 
</p>
<pre class="code php"><span class="re1">$user</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'user'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="re1">$user</span><span class="sy0">-&gt;</span><span class="me1">has</span><span class="br0">(</span>ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'role'</span><span class="sy0">,</span> <span class="st0">'login'</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h3><a name="add" id="add">add</a></h3>
<div class="level3">

<p>

Adds a relationship to an object that has a many-to-many relationship. The following code will add the <code>admin</code> role to a user. Note that this will add the relationship and related records <em>immediately</em>, rather than when the object is saved.
</p>
<pre class="code php"><span class="re1">$user</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'user'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="re1">$user</span><span class="sy0">-&gt;</span><span class="me1">add</span><span class="br0">(</span>ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'role'</span><span class="sy0">,</span> <span class="st0">'admin'</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h3><a name="remove" id="remove">remove</a></h3>
<div class="level3">

<p>

Remove a relationship from an object that has a many-to-many relationship. The following code will remove the <code>login</code> role from the user. Note that this will remove the relationship and related records <em>immediately</em>, rather than when the object is saved.
</p>
<pre class="code php"><span class="re1">$user</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'user'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="re1">$user</span><span class="sy0">-&gt;</span><span class="me1">remove</span><span class="br0">(</span>ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'role'</span><span class="sy0">,</span> <span class="st0">'login'</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h3><a name="with" id="with">with</a></h3>
<div class="level3">

<p>

Binds a one-to-one relationship using a JOIN.  This is useful in situations where you do not want to use lazy-loading, thus improving performance.  You can also bind nested one-to-one relationships using a colon.
</p>
<pre class="code php"><span class="co1">// This uses 1 SQL query to fetch the user, associated city, and associated country.</span>
<span class="re1">$users</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'user'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">with</span><span class="br0">(</span><span class="st0">'city'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">with</span><span class="br0">(</span><span class="st0">'city:country'</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">find_all</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">foreach</span><span class="br0">(</span><span class="re1">$users</span> <span class="kw1">as</span> <span class="re1">$user</span><span class="br0">)</span> <span class="br0">{</span>
  <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$user</span><span class="sy0">-&gt;</span><span class="me1">city</span><span class="sy0">-&gt;</span><span class="me1">country</span><span class="sy0">-&gt;</span><span class="me1">name</span>
<span class="br0">}</span></pre>
<p>
You can also set the <code>$load_with</code> property of the ORM model to bind automatically.
</p>

</div>

<h2><a name="properties" id="properties">Properties</a></h2>
<div class="level2">

<p>

ORM has several public object properties which can be used for various purposes. By default, all of these properties are managed by ORM and will change dynamically based on object. They should never be manually set in a model.

</p>

</div>

<h3><a name="loaded" id="loaded">loaded</a></h3>
<div class="level3">

<p>

Boolean for seeing whether the current object has been loaded from the database. This can be used to test if an object has been successfully loaded.
</p>
<pre class="code php"><span class="re1">$article</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">if</span> <span class="br0">(</span><span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">loaded</span><span class="sy0">==</span><span class="kw2">true</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="st0">'loaded article '</span><span class="sy0">,</span> <span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">id</span><span class="sy0">;</span>
<span class="br0">}</span>
<span class="kw1">else</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="st0">'no article by that id exists'</span><span class="sy0">;</span>
<span class="br0">}</span></pre>
</div>

<h3><a name="saved" id="saved">saved</a></h3>
<div class="level3">

<p>

Boolean for checking whether the current object is saved.

</p>
<pre class="code php"><span class="re1">$article</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'article'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">if</span><span class="br0">(</span><span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">saved</span><span class="sy0">==</span><span class="kw2">false</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="st0">'not saved'</span><span class="sy0">;</span>
<span class="br0">}</span>
 
<span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">save</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">if</span><span class="br0">(</span><span class="re1">$article</span><span class="sy0">-&gt;</span><span class="me1">saved</span><span class="sy0">==</span><span class="kw2">true</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="st0">'saved'</span><span class="sy0">;</span>
<span class="br0">}</span></pre>
</div>

<h3><a name="object_name" id="object_name">object_name</a></h3>
<div class="level3">

<p>

The simple name of the object. If my class is named <code>Blog_Post_Model</code>, then <code>blog_post</code> is the <code>object_name</code>.
</p>

</div>

<h3><a name="primary_key" id="primary_key">primary_key</a></h3>
<div class="level3">

<p>

The column name of the primary key.
</p>

</div>

<h3><a name="primary_val" id="primary_val">primary_val</a></h3>
<div class="level3">

<p>

A convenience value corresponding to a column in the table. By default it is set to <code>name.</code> It can be used as a more human-friendly identifier for table rows. For instance, if you had a <code>users</code> table, you might set it to <code>username.</code> 
</p>

</div>

<h3><a name="table_name" id="table_name">table_name</a></h3>
<div class="level3">

<p>

The name of the database table that holds the records.
</p>

</div>

<h3><a name="table_columns" id="table_columns">table_columns</a></h3>
<div class="level3">

<p>

The database table column information that is being used.
</p>

</div>

<h3><a name="sorting" id="sorting">sorting</a></h3>
<div class="level3">

<p>

An array of sorting parameters that should be applied to queries. By default, results are sorted by <code>id ASC</code>. You can add multiple columns and directions to this property.
</p>
<pre class="code php"><span class="kw2">class</span> User_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
 
    protected <span class="re1">$sorting</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'last_login'</span> <span class="sy0">=&gt;</span> <span class="st0">'desc'</span><span class="sy0">,</span> <span class="st0">'username'</span> <span class="sy0">=&gt;</span> <span class="st0">'asc'</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="br0">}</span></pre>
</div>

<h2><a name="choosing_a_database" id="choosing_a_database">Choosing A Database</a></h2>
<div class="level2">

<p>

Kohana currently supports three databases that allow for true foreign keys: PostgreSQL, MySQL (using <a href="http://dev.mysql.com/doc/mysql/en/innodb.html" class="urlextern" title="http://dev.mysql.com/doc/mysql/en/innodb.html" rel="nofollow">InnoDB</a> tables), and MSSQL. By using one of these databases, relationship integrity is enforced at the the database level.
</p>

<p>
For example, you can create a table that will automatically delete rows when a foreign key is deleted:
</p>
<pre class="code sql"><span class="co1">-- roles_users joining table (MySQL)</span>
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> roles_users <span class="br0">(</span>
  user_id smallint<span class="br0">(</span><span class="nu0">5</span><span class="br0">)</span> <span class="kw1">UNSIGNED</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  role_id tinyint<span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span> <span class="kw1">UNSIGNED</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span>,
  <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>  <span class="br0">(</span>user_id,role_id<span class="br0">)</span>,
  <span class="kw1">KEY</span> fk_role_id <span class="br0">(</span>role_id<span class="br0">)</span>
<span class="br0">)</span> ENGINE<span class="sy0">=</span>InnoDB <span class="kw1">DEFAULT</span> CHARSET<span class="sy0">=</span>utf8;
 
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="st0">`roles_users`</span>
  <span class="kw1">ADD</span> CONSTRAINT roles_users_ibfk_1 <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">(</span>user_id<span class="br0">)</span> <span class="kw1">REFERENCES</span> users <span class="br0">(</span>id<span class="br0">)</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> CASCADE,
  <span class="kw1">ADD</span> CONSTRAINT roles_users_ibfk_2 <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span> <span class="br0">(</span>role_id<span class="br0">)</span> <span class="kw1">REFERENCES</span> roles <span class="br0">(</span>id<span class="br0">)</span> <span class="kw1">ON</span> <span class="kw1">DELETE</span> CASCADE;</pre>
<p>
Use constraints like this will automatically delete the relationship between the user or role objects when either is deleted.
</p>

</div>

<h2><a name="examples" id="examples">Examples</a></h2>
<div class="level2">

</div>

<h3><a name="accessing_orm_data_using_foreach" id="accessing_orm_data_using_foreach">Accessing ORM Data using foreach</a></h3>
<div class="level3">

<p>
If we have two tables in a one_to_many relationship: schools and students (a school has many students) and want to list information about each student in the school you need to use a foreach loop.  <strong>Note:</strong> As you loop through the objects using foreach, only one object exists at any given point.  Note: Each time the loop continues, the old object is replaced by a new object. This is done to keep memory usage low when working with many objects at once.
</p>
<pre class="code php"><span class="co1">// in your School_Model</span>
protected <span class="re1">$has_many</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'students'</span><span class="br0">)</span><span class="sy0">;</span></pre><pre class="code php"><span class="co1">// in your Student_Model</span>
protected <span class="re1">$belongs_to</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'school'</span><span class="br0">)</span><span class="sy0">;</span></pre><pre class="code php"><span class="co1">// in your controller</span>
 
<span class="co1">// create a new ORM object for school id = 1</span>
<span class="re1">$school</span> <span class="sy0">=</span> <span class="kw2">new</span> School_Model<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="co1">// iterate through all of the students associated with the school and output their name</span>
<span class="kw1">foreach</span> <span class="br0">(</span><span class="re1">$school</span><span class="sy0">-&gt;</span><span class="me1">students</span> <span class="kw1">as</span> <span class="re1">$student</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$student</span><span class="sy0">-&gt;</span><span class="me1">name</span><span class="sy0">.</span><span class="st0">'&lt;br/&gt;'</span><span class="sy0">;</span>
<span class="br0">}</span></pre>
</div>

<h3><a name="combining_orm_and_pagination" id="combining_orm_and_pagination">Combining ORM and Pagination</a></h3>
<div class="level3">

<p>

ORM and Pagination can be combined quickly by using the <code>count_last_query</code> method. The following example would be used in a controller.
</p>
<pre class="code php"><span class="re1">$per_page</span> <span class="sy0">=</span> <span class="re1">$this</span><span class="sy0">-&gt;</span><span class="me1">input</span><span class="sy0">-&gt;</span><span class="me1">get</span><span class="br0">(</span><span class="st0">'limit'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
<span class="re1">$page_num</span> <span class="sy0">=</span> <span class="re1">$this</span><span class="sy0">-&gt;</span><span class="me1">input</span><span class="sy0">-&gt;</span><span class="me1">get</span><span class="br0">(</span><span class="st0">'page'</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">)</span><span class="sy0">;</span>
<span class="re1">$offset</span>   <span class="sy0">=</span> <span class="br0">(</span><span class="re1">$page_num</span> <span class="sy0">-</span> <span class="nu0">1</span><span class="br0">)</span> <span class="sy0">*</span> <span class="re1">$per_page</span><span class="sy0">;</span>
 
<span class="re1">$user</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'user'</span><span class="sy0">,</span> <span class="st0">'john.smith'</span><span class="br0">)</span><span class="sy0">;</span>
<span class="re1">$posts</span> <span class="sy0">=</span> <span class="re1">$user</span><span class="sy0">-&gt;</span><span class="me1">limit</span><span class="br0">(</span><span class="re1">$per_page</span><span class="sy0">,</span> <span class="re1">$offset</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">blog_posts</span><span class="sy0">;</span>
<span class="re1">$pages</span> <span class="sy0">=</span> <span class="re1">$pages</span> <span class="sy0">=</span> Pagination<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><a href="http://www.php.net/array"><span class="kw3">array</span></a>
<span class="br0">(</span>
    <span class="st0">'style'</span> <span class="sy0">=&gt;</span> <span class="st0">'digg'</span><span class="sy0">,</span>
    <span class="st0">'items_per_page'</span> <span class="sy0">=&gt;</span> <span class="re1">$per_page</span><span class="sy0">,</span>
    <span class="st0">'query_string'</span> <span class="sy0">=&gt;</span> <span class="st0">'page'</span><span class="sy0">,</span>
    <span class="st0">'total_items'</span> <span class="sy0">=&gt;</span> <span class="re1">$user</span><span class="sy0">-&gt;</span><span class="me1">count_last_query</span><span class="br0">(</span><span class="br0">)</span>
<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">foreach</span> <span class="br0">(</span><span class="re1">$posts</span> <span class="kw1">as</span> <span class="re1">$post</span><span class="br0">)</span>
<span class="br0">{</span>
    <a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">title</span><span class="sy0">,</span> <span class="st0">' by '</span><span class="sy0">,</span> <span class="re1">$post</span><span class="sy0">-&gt;</span><span class="me1">author</span><span class="sy0">-&gt;</span><span class="me1">username</span><span class="sy0">,</span> <span class="st0">'&lt;br/&gt;'</span><span class="sy0">;</span>
<span class="br0">}</span>
<a href="http://www.php.net/echo"><span class="kw3">echo</span></a> <span class="re1">$pages</span><span class="sy0">;</span></pre>
</div>

<h3><a name="relating_new_objects_using_orm" id="relating_new_objects_using_orm">Relating New Objects Using ORM</a></h3>
<div class="level3">

<p>
When creating a database record when there are associated columns in a one-to-many relationship, you need to obtain the last insert id of the parent object to properly add an associated child row.  The <code>save()</code> method in ORM sets the primary key of the object (usually <code>id</code>) to the last_insert_id.
</p>
<pre class="code php"><span class="co1">// models/page.php</span>
<span class="kw2">class</span> Page_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
	protected <span class="re1">$has_many</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'keywords'</span><span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span>
 
<span class="co1">// models/keyword.php</span>
<span class="kw2">class</span> Keyword_Model <span class="kw2">extends</span> ORM <span class="br0">{</span>
	protected <span class="re1">$belongs_to</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st0">'pages'</span><span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span>
 
<span class="co1">// in your controller</span>
 
<span class="co1">// create a new page object</span>
<span class="re1">$page</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'page'</span><span class="br0">)</span><span class="sy0">;</span>
<span class="re1">$page</span><span class="sy0">-&gt;</span><span class="me1">title</span> <span class="sy0">=</span> <span class="st0">"Test Page"</span><span class="sy0">;</span>
<span class="re1">$page</span><span class="sy0">-&gt;</span><span class="me1">content</span> <span class="sy0">=</span> <span class="st0">"This is a test page"</span><span class="sy0">;</span>
<span class="re1">$page</span><span class="sy0">-&gt;</span><span class="me1">save</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="re1">$keyword</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">'keyword'</span><span class="br0">)</span><span class="sy0">;</span>
<span class="re1">$keyword</span><span class="sy0">-&gt;</span><span class="me1">name</span> <span class="sy0">=</span> <span class="st0">"testing"</span><span class="sy0">;</span>
<span class="re1">$keyword</span><span class="sy0">-&gt;</span><span class="me1">page_id</span> <span class="sy0">=</span> <span class="re1">$page</span><span class="sy0">-&gt;</span><span class="me1">id</span><span class="sy0">;</span>  <span class="co1">// $page-&gt;id has the last insert id from the above save</span>
<span class="re1">$keyword</span><span class="sy0">-&gt;</span><span class="me1">save</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span></pre>
</div>

<h2><a name="advanced_usage" id="advanced_usage">Advanced Usage</a></h2>
<div class="level2">

</div>

<h3><a name="using_unique_keys_to_construct_orm" id="using_unique_keys_to_construct_orm">Using unique keys to construct ORM</a></h3>
<div class="level3">

<p>

By default, ORM will load using the <strong>id</strong> column as the identifier for the unique row within the database. However it is possible to allow ORM to load the object from other unique keys. ORM uses a method called <strong>unique_key</strong> to load data and this method can be overloaded within your ORM model to allow other columns to be used.
</p>

<p>
The example demonstrates the use of <strong>unique_key</strong> within an ORM model. The <strong>id</strong> is checked for data type. If the datatype is not a digit and is a string, the column <strong>shortname</strong> will be used to load the model.
</p>
<pre class="code php"><span class="kw2">public</span> <span class="kw2">function</span> unique_key<span class="br0">(</span><span class="re1">$id</span> <span class="sy0">=</span> <span class="kw2">NULL</span><span class="br0">)</span>
<span class="br0">{</span>
	<span class="kw1">if</span> <span class="br0">(</span> <span class="sy0">!</span> <a href="http://www.php.net/empty"><span class="kw3">empty</span></a><span class="br0">(</span><span class="re1">$id</span><span class="br0">)</span> AND <a href="http://www.php.net/is_string"><span class="kw3">is_string</span></a><span class="br0">(</span><span class="re1">$id</span><span class="br0">)</span> AND <span class="sy0">!</span> <a href="http://www.php.net/ctype_digit"><span class="kw3">ctype_digit</span></a><span class="br0">(</span><span class="re1">$id</span><span class="br0">)</span> <span class="br0">)</span>
	<span class="br0">{</span>
		<span class="kw1">return</span> <span class="st0">'shortname'</span><span class="sy0">;</span>
	<span class="br0">}</span>
 
	<span class="kw1">return</span> parent<span class="sy0">::</span><span class="me2">unique_key</span><span class="br0">(</span><span class="re1">$id</span><span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span></pre>
<p>
If you intend to you use custom unique keys within your application, it is a good idea to ensure you correctly index all columns being used as a unique identifier. This will ensure that as your application scales, performance is not adversely effected.
</p>

<p>
Assuming the <strong>homepage</strong> record has an ID of 1, including the <strong>unique_key</strong> method within your ORM model allows the following constructor methods in your code.
</p>
<pre class="code php"><span class="co1">// Using the ORM::factory method</span>
<span class="re1">$my_page</span> <span class="sy0">=</span> ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span> <span class="st0">'Page'</span><span class="sy0">,</span> <span class="st0">'homepage'</span> <span class="br0">)</span><span class="sy0">;</span>
 
<span class="co1">// Using the standard constructor</span>
<span class="re1">$my_other_page</span> <span class="sy0">=</span> <span class="kw2">new</span> Page_Model<span class="br0">(</span> <span class="st0">'homepage'</span> <span class="br0">)</span><span class="sy0">;</span>
 
<span class="re1">$my_old_method</span> <span class="sy0">=</span> <span class="kw2">new</span> Page_Model<span class="br0">(</span> <span class="nu0">1</span> <span class="br0">)</span><span class="sy0">;</span></pre>
<p>
<strong>$my_page</strong>, <strong>$my_other_page</strong> and <strong>$my_old_method</strong> will all contain the same record.
</p>

</div>

<h3><a name="orm_tree" id="orm_tree">ORM Tree</a></h3>
<div class="level3">

<p>

ORM tree is an ORM extension that allows creating an object relationship with itself. Typical use of this library can be a category hierarchy, in other words parent ↔ childrens link.
</p>
<pre class="code php"><span class="kw2">class</span> Category_Model <span class="kw2">extends</span> ORM_Tree
<span class="br0">{</span>
	protected <span class="re1">$children</span> <span class="sy0">=</span> <span class="st0">"categories"</span><span class="sy0">;</span>
<span class="br0">}</span></pre><pre class="code php"><a href="http://www.php.net/echo"><span class="kw3">echo</span></a> Kohana<span class="sy0">::</span><span class="me2">debug</span><span class="br0">(</span>ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">"Category"</span><span class="sy0">,</span> <span class="nu0">42</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">children</span><span class="sy0">-&gt;</span><span class="me1">as_array</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
<span class="co1">//returns the children for the category with id 42</span></pre><pre class="code php"><a href="http://www.php.net/echo"><span class="kw3">echo</span></a> Kohana<span class="sy0">::</span><span class="me2">debug</span><span class="br0">(</span>ORM<span class="sy0">::</span><span class="me2">factory</span><span class="br0">(</span><span class="st0">"Category"</span><span class="sy0">,</span> <span class="nu0">4</span><span class="br0">)</span><span class="sy0">-&gt;</span><span class="me1">parent</span><span class="sy0">-&gt;</span><span class="me1">name</span><span class="br0">)</span><span class="sy0">;</span>
<span class="co1">//returns the parent name of the category with ID 4</span></pre>
</div>

<!-- wikipage stop -->

</div>
<!-- End Body -->


<div id="wikibar" class="clearfix">
	<div class="meta">
		<div class="user">
					</div>
		<div class="doc">
			libraries/orm.txt · Last modified: 2008/12/15 13:31 by jheathco			 
		</div>
	</div>

	</div>

<div id="footer"><strong>©2007-2008 Kohana Team. All rights reserved.</strong></div>


<div class="no"><img src="/lib/exe/indexer.php?id=libraries%3Aorm&amp;1229411579" width="1" height="1" alt=""></div>
</body></html>
